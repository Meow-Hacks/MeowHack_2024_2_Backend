name: Build && Deploy
on:
  push:
    branches:
      - LoginMicroservice
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse HEAD revision
        run: echo "COMMIT_HASH=$(git rev-parse HEAD | head -c 8)" >> "$GITHUB_ENV"

      - name: Build mh_loginmicroservice
        run: docker build -f Dockerfile -t "mh_loginmicroservice:$COMMIT_HASH" .
      - name: Tag mh_loginmicroservice
        run: >
          docker image tag "mh_loginmicroservice:$COMMIT_HASH"
          "ghcr.io/meow-hacks/mh_loginmicroservice:latest"

      - name: Login into registry
        run: docker login -u meow-hacks -p ${{ secrets.MEOWHACKS_ACCESS_TOKEN_CLASSIC }} ghcr.io

      - name: Push mh_loginmicroservice image
        run: docker push ghcr.io/meow-hacks/mh_loginmicroservice:latest

      - name: Delete old mh_loginmicroservice images
        uses: actions/delete-package-versions@v5
        with:
          package-name: mh_loginmicroservice
          package-type: container
          min-versions-to-keep: 1
          token: ${{ secrets.MEOWHACKS_ACCESS_TOKEN_CLASSIC }}

      - name: Deploy containers
        run: |
          echo "${{ secrets.DEPLOY_CERT }}" > deploy.cert
          chmod 600 deploy.cert
          ssh -o "StrictHostKeyChecking no" -i deploy.cert "ci@${{ vars.DEPLOY_HOST }}" "cd ~/mh_loginmicroservice && ./deploy.sh"